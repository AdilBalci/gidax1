<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="theme-color" content="#6366f1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>GidaX - AkÄ±llÄ± GÄ±da Analizi</title>
  <link rel="manifest" href="/manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
:root{--bg:#0f0f17;--card:#1a1a25;--border:#2a2a3a;--primary:#6366f1;--success:#22c55e;--warning:#f59e0b;--danger:#ef4444;--text:#fff;--muted:#888}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.app{max-width:480px;margin:0 auto;padding:16px;padding-bottom:90px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.logo{font-size:1.5rem;font-weight:800;background:linear-gradient(135deg,var(--primary),#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.icon-btn{width:40px;height:40px;border-radius:12px;background:var(--card);border:1px solid var(--border);color:var(--text);font-size:1.2rem;cursor:pointer}
.tabs{display:flex;gap:8px;margin-bottom:20px}
.tab{flex:1;padding:12px;background:var(--card);border:2px solid transparent;border-radius:14px;color:var(--muted);font-size:0.8rem;font-weight:600;cursor:pointer;text-align:center}
.tab.active{border-color:var(--primary);color:var(--text);background:rgba(99,102,241,0.1)}
.tab span{display:block;font-size:1.3rem;margin-bottom:4px}
.section{display:none}.section.active{display:block}
.upload{border:2px dashed var(--border);border-radius:16px;padding:40px;text-align:center;cursor:pointer;transition:all 0.2s}
.upload:hover{border-color:var(--primary)}
.upload.has-img{padding:0;border-style:solid}
.upload .icon{font-size:3rem;margin-bottom:8px}
.upload .text{color:var(--muted);font-size:0.9rem}
.upload img{width:100%;height:200px;object-fit:cover;border-radius:14px;display:none}
.upload.has-img img{display:block}
.upload.has-img .icon,.upload.has-img .text{display:none}
.scanner-box{background:#000;border-radius:16px;overflow:hidden;position:relative;margin-bottom:12px}
#reader{width:100%;min-height:280px}
.scan-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
.scan-frame{width:200px;height:100px;border:3px solid var(--primary);border-radius:8px;position:relative}
.scan-frame::before{content:'';position:absolute;left:10%;right:10%;height:2px;background:var(--success);animation:scan 2s ease-in-out infinite}
@keyframes scan{0%,100%{top:10%}50%{top:90%}}
.scan-hint{text-align:center;color:var(--muted);font-size:0.8rem;margin-bottom:12px}
.scan-result{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:12px;padding:12px;margin-bottom:12px;display:none}
.scan-result.show{display:block}
.scan-result strong{color:var(--success)}
.scan-result code{font-size:1.1rem;display:block;margin-top:4px}
.input-row{display:flex;gap:8px}
.input-row input{flex:1;padding:14px;background:var(--card);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:1rem}
.input-row input:focus{outline:none;border-color:var(--primary)}
.input-row input::placeholder{color:var(--muted)}
.btn{width:100%;padding:16px;background:linear-gradient(135deg,var(--primary),#a855f7);border:none;border-radius:14px;color:#fff;font-size:1rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-top:12px}
.btn:disabled{opacity:0.5;cursor:not-allowed}
.btn.secondary{background:var(--card);border:1px solid var(--border)}
.btn .spinner{width:20px;height:20px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 0.8s linear infinite;display:none}
.btn.loading .spinner{display:block}
.btn.loading .btn-text{display:none}
@keyframes spin{to{transform:rotate(360deg)}}
.divider{display:flex;align-items:center;gap:12px;margin:16px 0;color:var(--muted);font-size:0.8rem}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border)}
.results{margin-top:20px;display:none}
.results.show{display:block}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:12px}
.alert{border-radius:12px;padding:14px;margin-bottom:12px;display:flex;align-items:center;gap:12px}
.alert.danger{background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3)}
.alert.warning{background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3)}
.alert.success{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3)}
.alert-icon{font-size:1.5rem}
.alert-content{flex:1}
.alert-title{font-weight:700;font-size:0.9rem}
.alert.danger .alert-title{color:var(--danger)}
.alert.warning .alert-title{color:var(--warning)}
.alert.success .alert-title{color:var(--success)}
.alert-text{font-size:0.8rem;color:var(--muted);margin-top:2px}
.product-header{display:flex;gap:12px;margin-bottom:16px}
.product-img{width:64px;height:64px;border-radius:12px;object-fit:cover;background:var(--border)}
.product-info{flex:1}
.product-brand{color:var(--primary);font-size:0.7rem;font-weight:600;text-transform:uppercase}
.product-name{font-size:1rem;font-weight:700;margin:2px 0}
.product-cat{color:var(--muted);font-size:0.8rem}
.fav-btn{background:none;border:none;font-size:1.5rem;cursor:pointer;opacity:0.5}
.fav-btn.active{opacity:1}
.score-row{display:flex;gap:10px;margin-bottom:16px}
.score-box{flex:1;background:rgba(99,102,241,0.1);border-radius:14px;padding:14px;text-align:center}
.score-label{font-size:0.65rem;text-transform:uppercase;color:var(--muted);margin-bottom:4px}
.score-value{font-size:1.8rem;font-weight:800}
.score-value.high{color:var(--success)}
.score-value.medium{color:var(--warning)}
.score-value.low{color:var(--danger)}
.nutri{width:44px;height:44px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:800;margin:0 auto}
.nutri.A{background:#038141}.nutri.B{background:#85bb2f}.nutri.C{background:#fecb02;color:#000}.nutri.D{background:#ee8100}.nutri.E{background:#e63e11}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px}
.grid-item{background:rgba(255,255,255,0.03);border-radius:12px;padding:12px 8px;text-align:center}
.grid-item .icon{font-size:1.2rem;margin-bottom:4px}
.grid-item .value{font-size:0.75rem;font-weight:700}
.grid-item .value.success{color:var(--success)}
.grid-item .value.warning{color:var(--warning)}
.grid-item .value.danger{color:var(--danger)}
.grid-item .label{font-size:0.55rem;color:var(--muted);margin-top:2px}
.nutri-table{margin-bottom:16px}
.nutri-table-title{font-size:0.75rem;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.nutri-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.85rem}
.nutri-row:last-child{border-bottom:none}
.nutri-row .label{color:var(--muted)}
.nutri-row .value{font-weight:600}
.ing-title{font-size:0.75rem;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.ing{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)}
.ing:last-child{border-bottom:none}
.ing-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.ing-dot.low{background:var(--success)}
.ing-dot.medium{background:var(--warning)}
.ing-dot.high{background:var(--danger)}
.ing-name{flex:1;font-size:0.85rem}
.ing-code{font-size:0.65rem;background:var(--border);padding:2px 6px;border-radius:4px;margin-left:4px}
.ing-risk{font-size:0.8rem;font-weight:600}
nav{position:fixed;bottom:0;left:0;right:0;background:rgba(15,15,23,0.95);backdrop-filter:blur(10px);border-top:1px solid var(--border);display:flex;justify-content:space-around;padding:8px 0;padding-bottom:max(8px,env(safe-area-inset-bottom))}
.nav-item{display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 16px;color:var(--muted);font-size:0.6rem;cursor:pointer;background:none;border:none}
.nav-item.active{color:var(--primary)}
.nav-item .nav-icon{font-size:1.3rem}
.nav-item.scan-btn{margin-top:-24px}
.nav-item.scan-btn .nav-icon{width:52px;height:52px;background:linear-gradient(135deg,var(--primary),#a855f7);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 15px rgba(99,102,241,0.4)}
.page{display:none}.page.active{display:block}
.list-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.list-header h2{font-size:1.1rem;font-weight:700}
.list-header button{background:none;border:none;color:var(--danger);font-size:0.8rem;cursor:pointer}
.list-item{display:flex;align-items:center;gap:12px;padding:12px;background:var(--card);border-radius:12px;margin-bottom:8px;cursor:pointer}
.list-item .thumb{width:44px;height:44px;border-radius:10px;background:var(--border);display:flex;align-items:center;justify-content:center;font-size:1.3rem}
.list-item .info{flex:1}
.list-item .name{font-weight:600;font-size:0.85rem}
.list-item .meta{font-size:0.7rem;color:var(--muted)}
.list-item .score{font-weight:700;font-size:1rem}
.empty{text-align:center;padding:40px;color:var(--muted)}
.empty .icon{font-size:3rem;margin-bottom:12px;opacity:0.5}
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--card);border:1px solid var(--border);padding:12px 24px;border-radius:12px;opacity:0;transition:all 0.3s;z-index:999}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(4px);z-index:100;display:none;align-items:flex-end;justify-content:center}
.modal.show{display:flex}
.modal-content{background:var(--card);border-radius:20px 20px 0 0;width:100%;max-width:480px;max-height:80vh;overflow-y:auto;padding:20px}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.modal-title{font-size:1rem;font-weight:700}
.modal-close{background:none;border:none;color:var(--muted);font-size:1.5rem;cursor:pointer}
.option-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px}
.option{display:flex;align-items:center;gap:8px;padding:12px;background:rgba(255,255,255,0.03);border:2px solid transparent;border-radius:10px;cursor:pointer;font-size:0.8rem}
.option.selected{border-color:var(--primary);background:rgba(99,102,241,0.1)}
  </style>
</head>
<body>
<div class="toast" id="toast"></div>
<div class="modal" id="profileModal">
  <div class="modal-content">
    <div class="modal-header">
      <span class="modal-title">ğŸ‘¤ SaÄŸlÄ±k Profilim</span>
      <button class="modal-close" onclick="App.closeModal()">Ã—</button>
    </div>
    <div style="font-size:0.7rem;color:var(--muted);margin-bottom:8px">ğŸ¥ HastalÄ±klar</div>
    <div class="option-grid" id="modalDiseases">
      <div class="option" data-v="diyabet"><span class="oicon">ğŸ©¸</span>Diyabet</div>
      <div class="option" data-v="hipertansiyon"><span class="oicon">ğŸ’“</span>Tansiyon</div>
      <div class="option" data-v="kolesterol"><span class="oicon">ğŸ«€</span>Kolesterol</div>
      <div class="option" data-v="kalp"><span class="oicon">â¤ï¸</span>Kalp</div>
    </div>
    <div style="font-size:0.7rem;color:var(--muted);margin-bottom:8px">âš¡ Hassasiyetler</div>
    <div class="option-grid" id="modalSensitivities">
      <div class="option" data-v="helal"><span class="oicon">â˜ªï¸</span>Helal</div>
      <div class="option" data-v="boykot"><span class="oicon">âœŠ</span>Boykot</div>
      <div class="option" data-v="vegan"><span class="oicon">ğŸŒ±</span>Vegan</div>
      <div class="option" data-v="yerli"><span class="oicon">ğŸ‡¹ğŸ‡·</span>Yerli</div>
    </div>
    <button class="btn" onclick="App.saveProfile()">ğŸ’¾ Kaydet</button>
  </div>
</div>
<div class="app">
  <header>
    <div class="logo">ğŸ”¬ GidaX</div>
    <button class="icon-btn" onclick="App.openModal()">ğŸ‘¤</button>
  </header>
  <div class="page active" id="homePage">
    <div class="tabs">
      <div class="tab active" data-tab="photo"><span>ğŸ“·</span>FotoÄŸraf</div>
      <div class="tab" data-tab="scan"><span>ğŸ“±</span>Barkod</div>
    </div>
    <div class="section active" id="photoSection">
      <div class="upload" id="uploadArea">
        <div class="icon">ğŸ“·</div>
        <div class="text">ÃœrÃ¼n fotoÄŸrafÄ± Ã§ek veya yÃ¼kle</div>
        <img id="preview" alt="">
      </div>
      <input type="file" id="fileInput" accept="image/*" hidden>
      <button class="btn" id="analyzeBtn" disabled><span class="spinner"></span><span class="btn-text">ğŸ” Analiz Et</span></button>
    </div>
    <div class="section" id="scanSection">
      <div class="scanner-box">
        <div id="reader"></div>
        <div class="scan-overlay"><div class="scan-frame"></div></div>
      </div>
      <div class="scan-hint">Barkodu Ã§erÃ§eveye hizalayÄ±n</div>
      <div class="scan-result" id="scanResult"><strong>âœ… Barkod Bulundu</strong><code id="scannedCode"></code></div>
      <button class="btn" id="scanBtn" disabled><span class="spinner"></span><span class="btn-text">ğŸ” Analiz Et</span></button>
      <div class="divider">veya manuel gir</div>
      <div class="input-row">
        <input type="text" id="barcodeInput" placeholder="Barkod numarasÄ±...">
        <button class="btn secondary" style="width:auto;margin:0" onclick="App.searchBarcode()">Ara</button>
      </div>
    </div>
    <div class="results" id="results">
      <div id="alertsContainer"></div>
      <div class="card">
        <div class="product-header">
          <img class="product-img" id="resultImg" alt="">
          <div class="product-info">
            <div class="product-brand" id="resultBrand"></div>
            <div class="product-name" id="resultName"></div>
            <div class="product-cat" id="resultCat"></div>
          </div>
          <button class="fav-btn" id="favBtn" onclick="App.toggleFav()">ğŸ¤</button>
        </div>
        <div class="score-row">
          <div class="score-box"><div class="score-label">SaÄŸlÄ±k Skoru</div><div class="score-value" id="scoreValue">-</div></div>
          <div class="score-box" id="nutriBox"><div class="score-label">Nutri-Score</div><div class="nutri" id="nutriValue">-</div></div>
        </div>
        <div class="grid">
          <div class="grid-item"><div class="icon">ğŸ¬</div><div class="value" id="sugar">-</div><div class="label">Åeker</div></div>
          <div class="grid-item"><div class="icon">ğŸ§ˆ</div><div class="value" id="fat">-</div><div class="label">YaÄŸ</div></div>
          <div class="grid-item"><div class="icon">ğŸ§‚</div><div class="value" id="salt">-</div><div class="label">Tuz</div></div>
          <div class="grid-item"><div class="icon">âš—ï¸</div><div class="value" id="additive">-</div><div class="label">KatkÄ±</div></div>
        </div>
        <div class="nutri-table" id="nutriTable">
          <div class="nutri-table-title">ğŸ“Š 100g BaÅŸÄ±na Besin DeÄŸerleri</div>
          <div id="nutriRows"></div>
        </div>
        <div class="ing-title">ğŸ§ª Ä°Ã§erik Analizi</div>
        <div id="ingredients"></div>
      </div>
      <button class="btn secondary" onclick="App.share()">ğŸ“¤ PaylaÅŸ</button>
    </div>
  </div>
  <div class="page" id="historyPage">
    <div class="list-header"><h2>ğŸ“‹ GeÃ§miÅŸ</h2><button onclick="App.clearHistory()">Temizle</button></div>
    <div id="historyList"></div>
    <div class="empty" id="emptyHistory"><div class="icon">ğŸ“‹</div><p>HenÃ¼z tarama yok</p></div>
  </div>
  <div class="page" id="favPage">
    <div class="list-header"><h2>â¤ï¸ Favoriler</h2><span id="favCount">0 Ã¼rÃ¼n</span></div>
    <div id="favList"></div>
    <div class="empty" id="emptyFav"><div class="icon">â¤ï¸</div><p>HenÃ¼z favori yok</p></div>
  </div>
</div>
<nav>
  <button class="nav-item active" data-page="homePage"><span class="nav-icon">ğŸ </span>Ana Sayfa</button>
  <button class="nav-item" data-page="historyPage"><span class="nav-icon">ğŸ“‹</span>GeÃ§miÅŸ</button>
  <button class="nav-item scan-btn" onclick="App.openScanner()"><span class="nav-icon">ğŸ“·</span></button>
  <button class="nav-item" data-page="favPage"><span class="nav-icon">â¤ï¸</span>Favoriler</button>
  <button class="nav-item" onclick="App.openModal()"><span class="nav-icon">ğŸ‘¤</span>Profil</button>
</nav>
<script>
const App={
  profile:JSON.parse(localStorage.getItem('gx_profile'))||{diseases:[],sensitivities:[]},
  history:JSON.parse(localStorage.getItem('gx_history'))||[],
  favorites:JSON.parse(localStorage.getItem('gx_favorites'))||[],
  currentResult:null,imageData:null,barcode:null,scanner:null,scanning:false,
  $:id=>document.getElementById(id),
  init(){
    document.querySelectorAll('.tab').forEach(t=>{t.onclick=()=>{document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.section').forEach(x=>x.classList.remove('active'));t.classList.add('active');this.$(t.dataset.tab+'Section').classList.add('active');this.$('results').classList.remove('show');t.dataset.tab==='scan'?this.startScanner():this.stopScanner()}});
    document.querySelectorAll('.nav-item[data-page]').forEach(n=>{n.onclick=()=>{document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));n.classList.add('active');this.$(n.dataset.page).classList.add('active');if(n.dataset.page==='historyPage')this.renderHistory();if(n.dataset.page==='favPage')this.renderFavorites();if(n.dataset.page!=='homePage')this.stopScanner()}});
    this.$('uploadArea').onclick=()=>this.$('fileInput').click();
    this.$('fileInput').onchange=e=>e.target.files[0]&&this.loadImage(e.target.files[0]);
    this.$('analyzeBtn').onclick=()=>this.analyze();
    this.$('scanBtn').onclick=()=>this.analyzeBarcode();
    this.$('barcodeInput').onkeypress=e=>e.key==='Enter'&&this.searchBarcode();
    document.querySelectorAll('.option').forEach(o=>{o.onclick=()=>o.classList.toggle('selected')});
    this.loadProfileToModal();
    if('serviceWorker'in navigator){navigator.serviceWorker.register('/sw.js').catch(()=>{})}
  },
  loadImage(file){const reader=new FileReader();reader.onload=e=>{const img=new Image();img.onload=()=>{const canvas=document.createElement('canvas');const max=1200;let w=img.width,h=img.height;if(w>max||h>max){if(w>h){h=h*max/w;w=max}else{w=w*max/h;h=max}}canvas.width=w;canvas.height=h;canvas.getContext('2d').drawImage(img,0,0,w,h);this.imageData=canvas.toDataURL('image/jpeg',0.8);this.$('preview').src=this.imageData;this.$('uploadArea').classList.add('has-img');this.$('analyzeBtn').disabled=false};img.src=e.target.result};reader.readAsDataURL(file)},
  async startScanner(){if(this.scanning)return;try{this.scanner=new Html5Qrcode('reader');await this.scanner.start({facingMode:'environment'},{fps:10,qrbox:{width:250,height:100}},code=>this.onScan(code),()=>{});this.scanning=true}catch(e){this.toast('Kamera aÃ§Ä±lamadÄ±')}},
  stopScanner(){if(this.scanner&&this.scanning){this.scanner.stop().then(()=>this.scanning=false).catch(()=>{})}},
  onScan(code){if(navigator.vibrate)navigator.vibrate(100);this.barcode=code;this.$('scannedCode').textContent=code;this.$('scanResult').classList.add('show');this.$('scanBtn').disabled=false;this.$('barcodeInput').value=code;setTimeout(()=>this.analyzeBarcode(),500)},
  openScanner(){document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));document.querySelector('.nav-item[data-page="homePage"]').classList.add('active');document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));this.$('homePage').classList.add('active');document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));document.querySelector('.tab[data-tab="scan"]').classList.add('active');document.querySelectorAll('.section').forEach(x=>x.classList.remove('active'));this.$('scanSection').classList.add('active');this.startScanner()},
  searchBarcode(){const code=this.$('barcodeInput').value.trim();if(code){this.barcode=code;this.analyzeBarcode()}},
  async analyze(){if(!this.imageData)return;const btn=this.$('analyzeBtn');btn.classList.add('loading');btn.disabled=true;this.$('results').classList.remove('show');try{const res=await fetch('/api/analyze',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({image:this.imageData,profile:this.profile})});const data=await res.json();if(data.error)throw new Error(data.error);this.currentResult=data;this.render(data);this.addToHistory(data)}catch(e){this.toast(e.message)}finally{btn.classList.remove('loading');btn.disabled=false}},
  async analyzeBarcode(){if(!this.barcode)return;const btn=this.$('scanBtn');btn.classList.add('loading');btn.disabled=true;try{const res=await fetch('/api/analyze',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({barcode:this.barcode,profile:this.profile})});const data=await res.json();if(data.error)throw new Error(data.error);this.currentResult=data;this.render(data);this.addToHistory(data);this.stopScanner()}catch(e){this.toast(e.message)}finally{btn.classList.remove('loading');btn.disabled=false}},
  render(d){
    // Alerts
    const alerts=d.sensitivityAlerts||[];
    this.$('alertsContainer').innerHTML=alerts.map(a=>`<div class="alert ${a.severity}"><div class="alert-icon">${a.icon}</div><div class="alert-content"><div class="alert-title">${a.title}</div><div class="alert-text">${a.message}</div></div></div>`).join('');
    
    // Product info
    this.$('resultImg').src=d.image||this.imageData||'';
    this.$('resultBrand').textContent=d.brand||'Marka BelirtilmemiÅŸ';
    this.$('resultName').textContent=d.product||'ÃœrÃ¼n';
    this.$('resultCat').textContent=d.category||'GÄ±da';
    
    // Scores
    const s=d.healthScore||50;
    const cls=s>=70?'high':s>=40?'medium':'low';
    this.$('scoreValue').textContent=s;
    this.$('scoreValue').className='score-value '+cls;
    
    // Nutri-Score
    if(['A','B','C','D','E'].includes(d.nutriScore)){
      this.$('nutriBox').style.display='block';
      this.$('nutriValue').textContent=d.nutriScore;
      this.$('nutriValue').className='nutri '+d.nutriScore;
    }else{
      this.$('nutriBox').style.display='none';
    }
    
    // Level indicators
    this.setLevel('sugar',d.sugarLevel);
    this.setLevel('fat',d.fatLevel);
    this.setLevel('salt',d.saltLevel);
    this.setLevel('additive',d.additiveLevel);
    
    // Nutrition table
    const n=d.nutrients||{};
    const nutriLabels={energy:'Enerji',protein:'Protein',carbs:'Karbonhidrat',sugar:'Åeker',fat:'YaÄŸ',saturatedFat:'DoymuÅŸ YaÄŸ',fiber:'Lif',salt:'Tuz'};
    let nutriHtml='';
    for(const[key,label]of Object.entries(nutriLabels)){
      if(n[key]){nutriHtml+=`<div class="nutri-row"><span class="label">${label}</span><span class="value">${n[key]}</span></div>`;}
    }
    this.$('nutriRows').innerHTML=nutriHtml||'<div class="nutri-row"><span class="label">Besin deÄŸerleri mevcut deÄŸil</span></div>';
    
    // Ingredients
    const ings=d.ingredients||[];
    if(ings.length){
      this.$('ingredients').innerHTML=ings.map(i=>`<div class="ing"><div class="ing-dot ${i.level||'low'}"></div><div class="ing-name">${i.name||'Ä°Ã§erik'}${i.code?`<span class="ing-code">${i.code}</span>`:''}</div>${i.risk!==undefined?`<div class="ing-risk" style="color:var(--${(i.level||'low')==='high'?'danger':(i.level||'low')==='medium'?'warning':'success'})">${i.risk}%</div>`:''}</div>`).join('');
    }else{
      this.$('ingredients').innerHTML='<div class="ing"><div class="ing-dot low"></div><div class="ing-name">Ä°Ã§erik bilgisi bulunamadÄ±</div></div>';
    }
    
    // Favorites
    const isFav=this.favorites.some(f=>f.product===d.product);
    this.$('favBtn').textContent=isFav?'â¤ï¸':'ğŸ¤';
    this.$('favBtn').classList.toggle('active',isFav);
    
    this.$('results').classList.add('show');
    this.$('results').scrollIntoView({behavior:'smooth'});
  },
  setLevel(id,v){
    const el=this.$(id);
    if(!v||v==='null'||v==='undefined'){el.textContent='â€”';el.className='value';return;}
    el.textContent=v;
    el.className='value '+(v.includes('DÃ¼ÅŸÃ¼k')?'success':v.includes('Orta')?'warning':'danger');
  },
  addToHistory(d){this.history.unshift({id:Date.now(),date:new Date().toLocaleDateString('tr-TR'),product:d.product||'ÃœrÃ¼n',brand:d.brand||'',score:d.healthScore||50,barcode:d.barcode||this.barcode});if(this.history.length>50)this.history.pop();localStorage.setItem('gx_history',JSON.stringify(this.history))},
  renderHistory(){if(!this.history.length){this.$('historyList').innerHTML='';this.$('emptyHistory').style.display='block';return}this.$('emptyHistory').style.display='none';this.$('historyList').innerHTML=this.history.map(h=>{const color=h.score>=70?'var(--success)':h.score>=40?'var(--warning)':'var(--danger)';return`<div class="list-item" onclick="App.reanalyze('${h.barcode||''}')"><div class="thumb">ğŸ“¦</div><div class="info"><div class="name">${h.product}</div><div class="meta">${h.brand||''}${h.brand?' â€¢ ':''}${h.date}</div></div><div class="score" style="color:${color}">${h.score}</div></div>`}).join('')},
  clearHistory(){if(confirm('GeÃ§miÅŸi silmek istediÄŸinize emin misiniz?')){this.history=[];localStorage.setItem('gx_history','[]');this.renderHistory();this.toast('GeÃ§miÅŸ temizlendi')}},
  reanalyze(barcode){if(barcode){this.barcode=barcode;this.openScanner();this.analyzeBarcode()}},
  toggleFav(){if(!this.currentResult)return;const idx=this.favorites.findIndex(f=>f.product===this.currentResult.product);if(idx>-1){this.favorites.splice(idx,1);this.$('favBtn').textContent='ğŸ¤';this.$('favBtn').classList.remove('active');this.toast('Favorilerden Ã§Ä±karÄ±ldÄ±')}else{this.favorites.unshift({id:Date.now(),product:this.currentResult.product,brand:this.currentResult.brand,score:this.currentResult.healthScore,barcode:this.currentResult.barcode||this.barcode});this.$('favBtn').textContent='â¤ï¸';this.$('favBtn').classList.add('active');this.toast('Favorilere eklendi')}localStorage.setItem('gx_favorites',JSON.stringify(this.favorites))},
  renderFavorites(){this.$('favCount').textContent=this.favorites.length+' Ã¼rÃ¼n';if(!this.favorites.length){this.$('favList').innerHTML='';this.$('emptyFav').style.display='block';return}this.$('emptyFav').style.display='none';this.$('favList').innerHTML=this.favorites.map(f=>{const color=(f.score||50)>=70?'var(--success)':(f.score||50)>=40?'var(--warning)':'var(--danger)';return`<div class="list-item"><div class="thumb">ğŸ“¦</div><div class="info"><div class="name">${f.product||'ÃœrÃ¼n'}</div><div class="meta">${f.brand||''}</div></div><div class="score" style="color:${color}">${f.score||50}</div></div>`}).join('')},
  openModal(){this.loadProfileToModal();this.$('profileModal').classList.add('show')},
  closeModal(){this.$('profileModal').classList.remove('show')},
  loadProfileToModal(){document.querySelectorAll('#modalDiseases .option').forEach(o=>{o.classList.toggle('selected',this.profile.diseases?.includes(o.dataset.v))});document.querySelectorAll('#modalSensitivities .option').forEach(o=>{o.classList.toggle('selected',this.profile.sensitivities?.includes(o.dataset.v))})},
  saveProfile(){this.profile.diseases=[...document.querySelectorAll('#modalDiseases .option.selected')].map(o=>o.dataset.v);this.profile.sensitivities=[...document.querySelectorAll('#modalSensitivities .option.selected')].map(o=>o.dataset.v);localStorage.setItem('gx_profile',JSON.stringify(this.profile));this.closeModal();this.toast('Profil kaydedildi')},
  share(){if(!this.currentResult)return;const text=`ğŸ”¬ GidaX\n${this.currentResult.brand||''} - ${this.currentResult.product||'ÃœrÃ¼n'}\nSkor: ${this.currentResult.healthScore||50}/100`;if(navigator.share){navigator.share({title:'GidaX',text})}else{navigator.clipboard.writeText(text);this.toast('KopyalandÄ±')}},
  toast(msg){const t=this.$('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000)}
};
document.addEventListener('DOMContentLoaded',()=>App.init());
</script>
</body>
</html>